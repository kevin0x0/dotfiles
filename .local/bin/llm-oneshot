#!/bin/sh

to_escaped_string() {
  sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\r/\\r/g; s/$/\\n/' | tr -d '\n'
}

do_curl() (
  url=$1
  api_key=$2

  if [ "$opt_append_prompt" = true ]; then
    input=
  else
    input='{"role": "user", "content": "'"$input"'"}'
  fi

  curl -Ns "$url" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $api_key" \
    -d '{
          "model": "'"$opt_model"'",
          "messages": [
            {"role": "system", "content": "'"$opt_prompt"'"}
              '"${input:+,}$input"'
          ],
          "stream": '"$opt_stream"',
          "temperature": 1.3
        }'

  # Output an empty line in the end to ensure the output always ends with newline.
  echo
)

make_valid_json() (
  if [ "$opt_stream" = "false" ]; then
    exec cat
  fi

  while IFS= read -r line; do
    if [ "$line" = "data: [DONE]" ]; then
      break
    fi
    printf "%s\n" "${line##data:}"
  done
)

get_content_delimiter() {
  content_delimiter=
  if [ "$1" = "$2" ] && [ "$opt_output_delimiter" = true ]; then
    if [ "$opt_0delimiter" = true ]; then
      content_delimiter='\u0000'
    else
      content_delimiter='================================================================================'
      if [ -n "$opt_delimiter_color" ]; then
        content_delimiter=$opt_delimiter_color$content_delimiter'\u001b[0m'
      fi
      content_delimiter='\n'$content_delimiter'\n'
    fi
  fi
  printf "%s" "$content_delimiter"
}

make_output() (
  last_output_type=none
  while IFS= read -r reasoning_content; IFS= read -r content; do
    content_delimiter=
    if [ "$reasoning_content" != "null" ] && [ "$opt_output_reasoning" = true ]; then
      content_delimiter=$(get_content_delimiter "$last_output_type" "content");
      last_output_type=reasoning_content
      reasoning_content=${reasoning_content#\"}
      reasoning_content=${reasoning_content%\"}
      printf "\"%s%s%s%s\"\n" "$content_delimiter" \
        "$opt_reasoning_content_color" \
        "$reasoning_content" \
        "${opt_reasoning_content_color:+\\u001b[0m}"
    fi

    content_delimiter=
    if [ "$content" != "null" ]; then
      content_delimiter=$(get_content_delimiter "$last_output_type" "reasoning_content");
      last_output_type=content
      content=${content#\"}
      content=${content%\"}
      printf "\"%s%s%s%s\"\n" "$content_delimiter" \
        "$opt_content_color" \
        "$content" \
        "${opt_content_color:+\\u001b[0m}"
    fi
  done | jq --unbuffered -j '.'
)

input=
opt_model=deepseek-chat
opt_append_newline=true
opt_stream=false
opt_append_prompt=false
opt_prompt=
opt_output_reasoning=true
opt_output_delimiter=true
opt_reasoning_content_color='\u001b[37;2m'
opt_content_color='\u001b[1m'
opt_delimiter_color='\u001b[31;1m'
opt_0delimiter=false

while getopts "aisp0f:m:c:" opt "$@"; do
   case "$opt" in
     a)
       opt_append_prompt=true
       ;;
     i)
       opt_no_input=true
       ;;
     s)
       opt_stream=true
       ;;
     p)
       opt_prompt=$(printf "%s\n" "$OPTARG" | to_escaped_string)
       ;;
     0)
       opt_0delimiter=true
       ;;
     f)
       opt_output_delimiter=false
       opt_output_reasoning=false
       case "$OPTARG" in
         *d*) opt_output_delimiter=true;;
       esac
       case "$OPTARG" in
         *r*) opt_output_reasoning=true;;
       esac
       ;;
     m)
       opt_model=$OPTARG
       ;;
     c)
       opt_reasoning_content_color='\u001b['${OPTARG%%,*}'m'
       opt_delimiter_color='\u001b['${OPTARG##*,}'m'
       opt_content_color=${OPTARG#*,}
       opt_content_color='\u001b['${opt_content_color%,*}'m'
       ;;
     '?')
       exit 1
       ;;
   esac
done

if ! [ -t 1 ]; then
  opt_reasoning_content_color=
  opt_content_color=
  opt_delimiter_color=
fi

shift $((OPTIND - 1))

if [ "${#opt_prompt}" -eq 0 ]; then
  opt_prompt="You are a knowledgeable assistant, and your task is to answer the questions provided by the user.\n"
fi

if [ "$#" -ne 0 ]; then
  input="$*"
else
  input=$(cat)
fi

if [ "$opt_append_prompt" = true ]; then
  opt_prompt=$opt_prompt$input
fi

opt_prompt=$(printf "%s\n" "$opt_prompt" | to_escaped_string)

if [ "$opt_append_prompt" = false ]; then
  input=$(printf "%s\n" "$input" | to_escaped_string)
fi

if [ "$opt_stream" = false ]; then
  selector_prefix='.choices[0].message'
else
  selector_prefix='.choices[0].delta'
fi

URL=https://api.deepseek.com/chat/completions
DEEPSEEK_API_KEY=$(decget "$(xdg-user-dir DOCUMENTS)/api_keys.gpg" DEEPSEEK_API_KEY)
if [ "$?" -ne 0 ]; then
  exit 1
fi

do_curl "$URL" "$DEEPSEEK_API_KEY" \
  | make_valid_json \
  | jq --unbuffered "$selector_prefix.reasoning_content?,$selector_prefix.content?" \
  | make_output

if [ "$opt_append_newline" = true ]; then
  echo
fi
