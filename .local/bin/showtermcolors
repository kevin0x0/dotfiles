#!/bin/sh

validate_number() {
  case "$1" in
    *[!0-9]*)
      echo "Need a number, got $1" >&2
      exit 1
      ;;
  esac
}

opt_show_number=
opt_number_format=%s
opt_dont_append_newline=
opt_block_size=30
opt_delimiter='
'
opt_max_block=1

while getopts "naf:s:c:d:" opt; do
  case "$opt" in
    n)
      opt_show_number=yes
      ;;
    a)
      opt_dont_append_newline=yes
      ;;
    f)
      opt_number_format=$OPTARG
      ;;
    s)
      validate_number "$OPTARG"
      opt_block_size=$OPTARG
      ;;
    c)
      validate_number "$OPTARG"
      opt_max_block=$OPTARG
      ;;
    d)
      opt_delimiter=$OPTARG
      ;;
    \?)
      exit 1
      ;;
  esac
done

nblock=0
while read number; do
  case ${#number} in
    6)
      r=${number%????}
      gb=${number#??}
      g=${gb%??}
      b=${gb#??}
      printf "\033[48;2;%u;%u;%um%${opt_block_size}s\033[0m$opt_number_format" \
        "0x$r" "0x$g" "0x$b" "" "${opt_show_number:+$number}"
      ;;
    1|2|3)
      case $number in
        00?)
          number=${number#00}
          ;;
        0??)
          number=${number#0}
          ;;
      esac
      printf "\033[48;5;%um%${opt_block_size}s\033[0m$opt_number_format" "$number" "" \
        "${opt_show_number:+$number}"
      ;;
    *)
      printf "%${opt_block_size}s$opt_number_format" "Unknown: " \
      "${opt_show_number:+$number}"
      ;;
  esac
  nblock=$((nblock + 1))
  if [ "$opt_max_block" -ne 0 ] && [ "$nblock" -ge "$opt_max_block" ]; then
    printf "%s" "$opt_delimiter"
    nblock=0
  fi
done

if [ -n "$opt_dont_append_newline" ]; then
  exit
fi

if [ "$nblock" -ne 0 ]; then
  printf "%s" "$opt_delimiter"
fi
