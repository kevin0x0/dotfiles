#!/usr/bin/dash

[ $# -eq 0 ] && exit 1

if [ -z "$interface" ]; then
  configfile=${XDG_CONFIG_HOME:-$HOME/.config}/wifi-connect

  if ! [ -f "$configfile" ]; then
    mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}"
    wifi-connect-generate-config >"$configfile"

    if ! [ -f "$configfile" ]; then
      exit 65
    fi
  fi

  . "$configfile"
fi

if [ -z "$interface" ]; then
  exit 64
fi

ifindex=$(cat "/sys/class/net/$interface/ifindex")
phyx=$(cat "/sys/class/net/$interface/phy80211/index")

print_if_is_network() {
  local name
  name=$(busctl --json short --system get-property \
    net.connman.iwd "$1" \
    net.connman.iwd.Network Name 2>/dev/null | fj -r '.data' 2>/dev/null)

  if [ "$?" -eq 0 ]; then
    printf "%s" "$name"
    return 0
  else
    return 1
  fi
}

list_network() {
  busctl --system tree net.connman.iwd \
    | sed -n 's@^.* \(/net/connman/iwd/'"$phyx/$ifindex"'/.*\)$@\1@p' \
    | \
    while IFS= read -r object; do
      if ! name=$(print_if_is_network "$object"); then
        continue
      fi

      if [ -n "$1" ]; then
        if [ "$name" = "$1" ]; then
          printf "%s" "$object"
          break
        fi
      else
        local connected="$(busctl --json short --system get-property \
          net.connman.iwd "$object" \
          net.connman.iwd.Network Connected 2>/dev/null | fj -r '.data')"

        if [ "$connected" = true ]; then
          printf "> "
        else
          printf "  "
        fi

        printf "%s\n" "$name"
      fi
    done
  }

if ! selected=$(list_network | "$@"); then
  exit 1
fi

selected=${selected#??}

object_path=$(list_network "$selected")
busctl --system call net.connman.iwd "$object_path" net.connman.iwd.Network Connect
