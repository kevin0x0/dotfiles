#!/bin/sh

to_escaped_string() {
  sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\r/\\r/g; s/$/\\n/' | tr -d '\n'
}

do_curl() (
  url=$1
  api_key=$2

  if [ "$opt_append_input_to_prompt" = true ]; then
    input='{"role": "system", "content": "'"$opt_prompt$input"'"}'
  elif [ "$opt_json_input" != true ]; then
    input='{"role": "system", "content": "'"$opt_prompt"'"},{"role": "user", "content": "'"$input"'"}'
  fi

  curl -Ns "$url" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $api_key" \
    -d '{
          "model": "'"$opt_model"'",
          "messages": [
              '"$input"'
          ],
          "stream": '"$opt_stream"',
          "temperature": 1.3
        }'

  # Output an empty line in the end to ensure the output always ends with newline.
  echo
)

parse_color() {
  set -- "$1,"
  while [ "${#1}" -ne 0 ]; do
    color=${1%%,*}
    case "$color" in
      reasoning_content=*)
        opt_reasoning_content_color="${color##*=}"
        ;;
      content=*)
        opt_content_color="${color##*=}"
        ;;
      reasoning_content_prefix=*)
        opt_reasoning_content_prefix_color="${color##*=}"
        ;;
      content_prefix=*)
        opt_content_prefix_color="${color##*=}"
        ;;
      all=*)
        opt_reasoning_content_color="${color##*=}"
        opt_content_color=$opt_reasoning_content_color
        opt_reasoning_content_prefix_color=$opt_reasoning_content_color
        opt_content_prefix_color=$opt_reasoning_content_color
    esac
    set -- "${1#*,}"
  done
}

parse_prefix() {
  set -- "$1,"
  while [ "${#1}" -ne 0 ]; do
    prefix=${1%%,*}
    case "$prefix" in
      reasoning_content=*)
        opt_reasoning_content_prefix="${prefix##*=}"
        ;;
      content=*)
        opt_content_prefix="${prefix##*=}"
        ;;
      all=*)
        opt_reasoning_content_prefix="${prefix##*=}"
        opt_content_prefix=$opt_reasoning_content_prefix
    esac
    set -- "${1#*,}"
  done
}

make_valid_json() (
  if [ "$opt_stream" = "false" ]; then
    exec cat
  fi

  while IFS= read -r line; do
    if [ "$line" = "data: [DONE]" ]; then
      break
    fi
    printf "%s\n" "${line##data:}"
  done
)

make_prefix() {
  if [ -n "$1" ]; then
    printf "\\u001b[%sm%s\\u001b[0m\n" "$1" "$2" \
      | sed 's/\\n/\\u001b[0m\\n\\u001b['"$1"'m/'
  else
    printf "%s" "$2"
  fi
}

make_ansi() {
  [ -z "$1" ] && return
  printf "\\u001b[%sm" "$1"
}


get_prefix() {
  [ "$1" = "$2" ] && return
  case "$2" in
    reasoning_content)
      prefix="$opt_reasoning_content_prefix"
      ;;
    content)
      prefix="$opt_content_prefix"
      ;;
  esac
  printf "%s" "$prefix"
}

make_output() (
  last_output_type=none
  while IFS= read -r reasoning_content; IFS= read -r content; do
    content_prefix=
    if [ "$reasoning_content" != "null" ] && [ "$opt_output_reasoning" = true ]; then
      content_prefix=$(get_prefix "$last_output_type" "reasoning_content");
      newline=
      [ "$last_output_type" = "content" ] && [ "$opt_append_newline" = true ] && newline='\n'
      last_output_type=reasoning_content
      reasoning_content=${reasoning_content#\"}
      reasoning_content=${reasoning_content%\"}
      printf "\"%s%s%s%s%s\"\n" "$newline" "$content_prefix" \
        "$opt_reasoning_content_color" \
        "$reasoning_content" \
        "${opt_reasoning_content_color:+\\u001b[0m}"
    fi

    content_prefix=
    if [ "$content" != "null" ]; then
      content_prefix=$(get_prefix "$last_output_type" "content");
      newline=
      [ "$last_output_type" = "reasoning_content" ] && [ "$opt_append_newline" = true ] && newline='\n'
      last_output_type=content
      content=${content#\"}
      content=${content%\"}
      printf "\"%s%s%s%s%s\"\n" "$newline" "$content_prefix" \
        "$opt_content_color" \
        "$content" \
        "${opt_content_color:+\\u001b[0m}"

      printf "%s" "$content" >&3
    fi
  done 3>"$opt_dump_content" | jq --unbuffered -j '.'
  [ "$opt_append_newline" = true ] && printf "\n"
)

input=
opt_model=deepseek-chat
opt_append_newline=true
opt_json_input=false
opt_stream=false
opt_append_input_to_prompt=false
opt_prompt=
opt_ansi_seq=auto
opt_output_reasoning=true
opt_reasoning_content_prefix='REASONING:\n'
opt_reasoning_content_color='37;2'
opt_reasoning_content_prefix_color='42;30;1'
opt_content_prefix='ANSWER:\n'
opt_content_color='1'
opt_content_prefix_color='43;30;1'
opt_dump_content=/dev/null

while getopts "ajsrNp:d:P:m:A:c:" opt "$@"; do
   case "$opt" in
     a)
       opt_append_input_to_prompt=true
       ;;
     j)
       opt_json_input=true
       ;;
     s)
       opt_stream=true
       ;;
     r)
       opt_output_reasoning=true
       ;;
     N)
       opt_append_newline=false
       ;;
     p)
       opt_prompt=$(printf "%s\n" "$OPTARG" | to_escaped_string)
       ;;
     d)
       opt_dump_content="$OPTARG"
       ;;
     P)
       parse_prefix "$OPTARG"
       ;;
     m)
       opt_model=$OPTARG
       ;;
     A)
       opt_ansi_seq=$OPTARG
       ;;
     c)
       parse_color "$OPTARG"
       ;;
     '?')
       exit 1
       ;;
   esac
done

shift $((OPTIND - 1))

if  { [ "$opt_ansi_seq" = "auto" ] && [ ! -t 1 ]; } \
  || [ "$opt_ansi_seq" = "never" ]; then
  opt_reasoning_content_color=
  opt_reasoning_content_prefix_color=
  opt_content_color=
  opt_content_prefix_color=
fi

opt_reasoning_content_prefix=$(make_prefix "$opt_reasoning_content_prefix_color" "$opt_reasoning_content_prefix")
opt_content_prefix=$(make_prefix "$opt_content_prefix_color" "$opt_content_prefix")
opt_reasoning_content_color=$(make_ansi "$opt_reasoning_content_color")
opt_content_color=$(make_ansi "$opt_content_color")

if [ "${#opt_prompt}" -eq 0 ]; then
  opt_prompt="You are a knowledgeable assistant, and your task is to answer the questions provided by the user. The question is:\n"
fi

if [ "$#" -ne 0 ]; then
  input="$*"
else
  input=$(cat)
fi

opt_prompt=$(printf "%s\n" "$opt_prompt" | to_escaped_string)
if [ "$opt_json_input" = false ]; then
  input=$(printf "%s\n" "$input" | to_escaped_string)
fi

if [ "$opt_stream" = false ]; then
  selector_prefix='.choices[0].message'
else
  selector_prefix='.choices[0].delta'
fi

URL=https://api.deepseek.com/chat/completions
DEEPSEEK_API_KEY=$(decget "$(xdg-user-dir DOCUMENTS)/api_keys.gpg" DEEPSEEK_API_KEY)
if [ "$?" -ne 0 ]; then
  exit 1
fi

do_curl "$URL" "$DEEPSEEK_API_KEY" \
  | make_valid_json \
  | jq --unbuffered "$selector_prefix.reasoning_content?,$selector_prefix.content?" \
  | make_output
