#!/bin/sh

lockfile="$XDG_RUNTIME_DIR/clash.pid.lock"
while ! (umask 0077; set -C; : >"$lockfile") 2>/dev/null; do
  echo "Another operation is in progress." >&2
  sleep 0.3
done

trap "rm '$lockfile'" EXIT

# If no clash process is running, exit with code 64
if ! pid=$(cat "$XDG_RUNTIME_DIR/clash.pid" 2>/dev/null); then
  echo "There are no instance of proxy is running." >&2
  exit 64
fi

sudo "$@" kill "$pid"
exitcode=$?
if [ "$exitcode" -eq 0 ]; then
  rm "$XDG_RUNTIME_DIR/clash.pid"
  exit 0
else
  exit "$exitcode"
fi
