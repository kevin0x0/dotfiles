#!/usr/bin/dash

set -e

to_escaped_string() {
  sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\r/\\r/g; s/$/\\n/' | tr -d '\n'
}

do_curl() {
  local url=$1 api_key=$2 model=$3 prompt=$4 input=$5 stream=$6

  curl -Ns "$url" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $api_key" \
    -d '{
          "model": "'"$model"'",
          "messages": [
            {"role": "system", "content": "'"$prompt"'"},
            {"role": "user", "content": "'"$input"'"}
          ],
          "stream": '"$stream"',
          "temperature": 1.3
        }'

  # Output an empty line in the end to ensure the output always ends with newline.
  echo
}

URL=https://api.deepseek.com/chat/completions
DEEPSEEK_API_KEY=$(decget "$(xdg-user-dir DOCUMENTS)/api_keys.gpg" DEEPSEEK_API_KEY)
MODEL=deepseek-chat

input=
opt_append_newline=yes
opt_stream=true
prompt=
while [ $# -ne 0 ]; do
  case "$1" in
    -N|--no-newline)
      opt_append_newline=
      ;;
    -S|--no-stream)
      opt_stream=false
      ;;
    -P|--prompt)
      if [ $# -eq 1 ]; then
        echo "Option $1 needs a value" >&2
        exit 1
      fi

      shift
      prompt=$(to_escaped_string <<EOF
$1
EOF
)
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      input=$input${input:+ }$1
      ;;
  esac
  shift
done

if [ "${#prompt}" -eq 0 ]; then
  prompt=$(to_escaped_string <<EOF
You are a knowledgeable assistant, and your task is to answer the questions provided by the user.
EOF
)
fi

if [ -n "$input" ]; then
  input=$(to_escaped_string <<EOF
$input
EOF
)
else
  input=$(to_escaped_string)
fi

do_curl "$URL" "$DEEPSEEK_API_KEY" "$MODEL" "$prompt" "$input" "$opt_stream" \
  | stdbuf -o 0 sed -n '/"content"\s*:/s/^.*"content"\s*:\s*"\(\([^"\\]\|\\.\)*\)".*$/\1/p' \
  | stdbuf -o 0 sed 's/\\"/"/' | while IFS= read -r line; do
  printf "%b" "$line"
done

if [ -n "$opt_append_newline" ]; then
  echo
fi
