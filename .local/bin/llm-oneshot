#!/bin/sh

to_escaped_string() {
  sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\r/\\r/g; s/$/\\n/' | tr -d '\n'
}

do_curl() (
  url=$1
  api_key=$2

  if [ "$opt_append_prompt" = true ]; then
    input=
  else
    input='{"role": "user", "content": "'"$input"'"}'
  fi

  curl -Ns "$url" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $api_key" \
    -d '{
          "model": "'"$opt_model"'",
          "messages": [
            {"role": "system", "content": "'"$opt_prompt"'"}
              '"${input:+,}$input"'
          ],
          "stream": '"$opt_stream"',
          "temperature": 1.3
        }'

  # Output an empty line in the end to ensure the output always ends with newline.
  echo
)

make_valid_json() (
  if [ "$opt_stream" = "false" ]; then
    exec cat
  fi

  while IFS= read -r line; do
    if [ "$line" = "data: [DONE]" ]; then
      break
    fi
    printf "%s\n" "${line##data:}"
  done
)

input=
opt_model=deepseek-chat
opt_append_newline=true
opt_stream=false
opt_append_prompt=false
opt_prompt=

while getopts "aisp:m:" opt "$@"; do
   case "$opt" in
     a)
       opt_append_prompt=true
       ;;
     s)
       opt_stream=true
       ;;
     p)
       opt_prompt=$(printf "%s\n" "$OPTARG" | to_escaped_string)
       ;;
     i)
       opt_no_input=true
       ;;
     m)
       opt_model=$OPTARG
       ;;
     '?')
       exit 1
       ;;
   esac
done

shift $((OPTIND - 1))

if [ "${#opt_prompt}" -eq 0 ]; then
  opt_prompt="You are a knowledgeable assistant, and your task is to answer the questions provided by the user.\n"
fi

if [ "$#" -ne 0 ]; then
  input="$*"
else
  input=$(cat)
fi

if [ "$opt_append_prompt" = true ]; then
  opt_prompt=$opt_prompt$input
fi

opt_prompt=$(printf "%s\n" "$opt_prompt" | to_escaped_string)

if [ "$opt_append_prompt" = false ]; then
  input=$(printf "%s\n" "$input" | to_escaped_string)
fi

if [ "$opt_stream" = false ]; then
  selector='.choices[0].message.content'
else
  selector='.choices[0].delta.content'
fi

URL=https://api.deepseek.com/chat/completions
DEEPSEEK_API_KEY=$(decget "$(xdg-user-dir DOCUMENTS)/api_keys.gpg" DEEPSEEK_API_KEY)
if [ "$?" -ne 0 ]; then
  exit 1
fi

do_curl "$URL" "$DEEPSEEK_API_KEY" \
  | make_valid_json \
  | fj -srfd '' "$selector"

if [ "$opt_append_newline" = true ]; then
  echo
fi
